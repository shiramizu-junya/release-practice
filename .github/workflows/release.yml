# .github/workflows/release.yml
#
# „Çø„Ç∞„Åå push „Åï„Çå„Åü„ÇâËá™Âãï„Åß:
#   1. „Éì„É´„Éâ„Åó„Å¶ ZIP „Çí‰ΩúÊàê
#   2. GitHub Release „Çí‰ΩúÊàêÔºà„É™„É™„Éº„Çπ„Éé„Éº„ÉàËá™ÂãïÁîüÊàê + ZIP Ê∑ª‰ªòÔºâ
#   3. Slack „Å´ÈÄöÁü•

name: Release

# ‚îÄ‚îÄ „Éà„É™„Ç¨„Éº: v „ÅßÂßã„Åæ„Çã„Çø„Ç∞„Åå push „Åï„Çå„Åü„Å®„Åç ‚îÄ‚îÄ
on:
  push:
    tags:
      - 'v*'

# ‚îÄ‚îÄ Ê®©Èôê: „É™„É™„Éº„Çπ‰ΩúÊàê„Å´ Contents write „ÅåÂøÖË¶Å ‚îÄ‚îÄ
permissions:
  contents: write

jobs:
  # ‚îÄ‚îÄ Job 1: „Éì„É´„Éâ & „É™„É™„Éº„Çπ‰ΩúÊàê ‚îÄ‚îÄ
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Build
        run: bash build.sh ${{ steps.version.outputs.version }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            release-practice-*.zip
          prerelease: ${{ contains(github.ref_name, '-beta') || contains(github.ref_name, '-rc') || contains(github.ref_name, '-alpha') }}

  # ‚îÄ‚îÄ Job 2: Slack ÈÄöÁü• ‚îÄ‚îÄ
  notify:
    runs-on: ubuntu-latest
    needs: release
    if: success()
    steps:
      - name: Get release info
        id: release_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BODY=$(gh api repos/${{ github.repository }}/releases/tags/${{ github.ref_name }} --jq '.body')
          URL=$(gh api repos/${{ github.repository }}/releases/tags/${{ github.ref_name }} --jq '.html_url')
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Slack notification
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üéâ ${{ github.ref_name }} „Çí„É™„É™„Éº„Çπ„Åó„Åæ„Åó„Åü",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ${{ toJSON(steps.release_info.outputs.body) }}
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "üìã „É™„É™„Éº„Çπ„Éé„Éº„Éà"
                      },
                      "url": "${{ steps.release_info.outputs.url }}"
                    }
                  ]
                }
              ]
            }
